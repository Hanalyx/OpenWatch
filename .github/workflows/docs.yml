name: Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'backend/**/*.py'
      - 'frontend/**/*.tsx'
      - 'frontend/**/*.ts'
      - 'README.md'
      - '.github/workflows/docs.yml'
  pull_request:
    paths:
      - 'docs/**'
      - 'backend/**/*.py'
      - 'frontend/**/*.tsx'
      - 'frontend/**/*.ts'
      - 'README.md'
      - '.github/workflows/docs.yml'

jobs:
  generate-api-docs:
    name: Generate API Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Create placeholder API docs
        run: |
          # Create placeholder directory structure
          mkdir -p backend/docs/build

          # Create simple API docs index
          cat > backend/docs/build/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>OpenWatch API Documentation</title>
            <meta charset="utf-8">
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; line-height: 1.6; }
              h1 { color: #3f51b5; }
              .note { background: #f5f5f5; padding: 15px; border-left: 4px solid #3f51b5; }
            </style>
          </head>
          <body>
            <h1>OpenWatch API Documentation</h1>
            <div class="note">
              <p><strong>Note:</strong> Full API documentation generation is currently being configured.</p>
              <p>For now, please refer to:</p>
              <ul>
                <li><a href="/api/openapi.json">OpenAPI Specification (JSON)</a></li>
                <li><a href="https://github.com/Hanalyx/OpenWatch">Source Code on GitHub</a></li>
                <li><a href="http://localhost:8000/docs">Local API Docs (FastAPI Swagger UI)</a></li>
              </ul>
            </div>
          </body>
          </html>
          EOF

          # Create empty openapi.json as placeholder
          echo '{"info": {"title": "OpenWatch API", "version": "1.0"}, "paths": {}}' > backend/openapi.json

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v7
        with:
          name: api-documentation
          path: |
            backend/docs/build/
            backend/openapi.json

  build-user-docs:
    name: Build User Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Create simple documentation index
        run: |
          # Create site directory with simple index
          mkdir -p site
          cat > site/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>OpenWatch Documentation</title>
            <meta charset="utf-8">
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              h1 { color: #3f51b5; }
              a { color: #3f51b5; text-decoration: none; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>OpenWatch Documentation</h1>
            <p>Security compliance scanning platform</p>
            <ul>
              <li><a href="../">Back to Repository</a></li>
              <li><a href="api/">API Documentation</a></li>
              <li><a href="https://github.com/Hanalyx/OpenWatch">GitHub Repository</a></li>
            </ul>
          </body>
          </html>
          EOF

      - name: Upload user documentation
        uses: actions/upload-artifact@v7
        with:
          name: user-documentation
          path: site/

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [generate-api-docs, build-user-docs]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download documentation artifacts
        uses: actions/download-artifact@v5

      - name: Prepare GitHub Pages
        run: |
          # Debug: List artifacts structure
          echo "=== Artifacts structure ==="
          ls -la

          mkdir -p public

          # Copy user documentation (site/)
          if [ -d "user-documentation" ]; then
            cp -r user-documentation/* public/
          fi

          # Copy API documentation
          mkdir -p public/api
          if [ -d "api-documentation" ]; then
            cp -r api-documentation/* public/api/
          fi

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          cname: docs.openwatch.hanalyx.com
