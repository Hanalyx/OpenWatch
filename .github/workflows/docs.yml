name: Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'backend/**/*.py'
      - 'frontend/**/*.tsx'
      - 'frontend/**/*.ts'
      - 'README.md'
      - '.github/workflows/docs.yml'
  pull_request:
    paths:
      - 'docs/**'
      - 'backend/**/*.py'
      - 'frontend/**/*.tsx'
      - 'frontend/**/*.ts'
      - 'README.md'
      - '.github/workflows/docs.yml'

jobs:
  generate-api-docs:
    name: Generate API Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install sphinx sphinx-rtd-theme sphinx-autodoc-typehints sphinxcontrib-openapi

      - name: Generate Python API docs
        working-directory: ./backend
        run: |
          # Set PYTHONPATH so Sphinx can import the app module
          export PYTHONPATH="${PYTHONPATH}:$(pwd)"

          # Create docs directory structure
          mkdir -p docs/source docs/source/_static

          # Generate Sphinx configuration
          cat > docs/source/conf.py << EOF
          import os
          import sys
          sys.path.insert(0, os.path.abspath('../../'))

          project = 'OpenWatch API'
          copyright = '2024, Hanalyx'
          author = 'Hanalyx Team'

          extensions = [
              'sphinx.ext.autodoc',
              'sphinx.ext.napoleon',
              'sphinx.ext.viewcode',
          ]

          templates_path = ['_templates']
          exclude_patterns = []

          html_theme = 'sphinx_rtd_theme'
          html_static_path = ['_static']

          # Mock imports for packages that have complex dependencies
          autodoc_mock_imports = [
              'fastapi', 'uvicorn', 'sqlalchemy', 'celery', 'redis',
              'motor', 'beanie', 'pymongo', 'paramiko', 'cryptography',
              'passlib', 'pyjwt', 'lxml', 'aiohttp', 'pydantic'
          ]
          EOF

          # Generate API documentation
          sphinx-apidoc -f -o docs/source app/

          # Build HTML documentation
          sphinx-build -b html docs/source docs/build

      - name: Generate OpenAPI spec
        working-directory: ./backend
        run: |
          python -c "
          from app.main import app
          import json
          openapi_schema = app.openapi()
          with open('openapi.json', 'w') as f:
              json.dump(openapi_schema, f, indent=2)
          "

      - name: Generate TypeScript API docs
        working-directory: ./frontend
        run: |
          npm ci
          npx typedoc src --out docs

      - name: Upload documentation artifacts
        uses: actions/upload-artifact@v4
        with:
          name: api-documentation
          path: |
            backend/docs/build/
            backend/openapi.json
            frontend/docs/

  build-user-docs:
    name: Build User Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Create simple documentation index
        run: |
          # Create site directory with simple index
          mkdir -p site
          cat > site/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <title>OpenWatch Documentation</title>
            <meta charset="utf-8">
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              h1 { color: #3f51b5; }
              a { color: #3f51b5; text-decoration: none; }
              a:hover { text-decoration: underline; }
            </style>
          </head>
          <body>
            <h1>OpenWatch Documentation</h1>
            <p>Security compliance scanning platform</p>
            <ul>
              <li><a href="../">Back to Repository</a></li>
              <li><a href="api/">API Documentation</a></li>
              <li><a href="https://github.com/Hanalyx/OpenWatch">GitHub Repository</a></li>
            </ul>
          </body>
          </html>
          EOF

      - name: Upload user documentation
        uses: actions/upload-artifact@v4
        with:
          name: user-documentation
          path: site/

  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: [generate-api-docs, build-user-docs]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Download documentation artifacts
        uses: actions/download-artifact@v5

      - name: Prepare GitHub Pages
        run: |
          mkdir -p public
          cp -r user-documentation/* public/
          mkdir -p public/api
          cp -r api-documentation/backend/docs/build/* public/api/
          cp api-documentation/backend/openapi.json public/api/
          mkdir -p public/api/typescript
          cp -r api-documentation/frontend/docs/* public/api/typescript/

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          cname: docs.openwatch.hanalyx.com
