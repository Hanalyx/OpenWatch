# Compliance Bundle Upload Bug Fixes - Testing Guide

## Summary of Fixes

This document describes three critical bugs that were fixed in the compliance bundle upload system and provides manual testing instructions.

---

## BUG #1: Invalid Top-Level `name` Field

**File**: `backend/app/cli/scap_json_to_openwatch_converter.py` (line 203)

**Problem**:
- Converter created invalid top-level `name` field that didn't exist in the ComplianceRule Pydantic model
- Pydantic silently dropped the field during validation
- MongoDB stored `name=None` for all rules from the first upload
- Subsequent uploads showed hash mismatches because new rules had `name` values

**Root Cause**:
```python
# BEFORE (BUG):
ow_rule = {
    "rule_id": f"ow-{rule_id}",
    "name": cac_rule.get("title", rule_id),  # ❌ INVALID - not in model
    "metadata": {
        "name": cac_rule.get("title", rule_id),  # Duplicate
        ...
    }
}
```

**Fix Applied**:
```python
# AFTER (FIXED):
ow_rule = {
    "rule_id": f"ow-{rule_id}",
    # NOTE: 'name' is intentionally stored ONLY in metadata.name (not top-level)
    # This matches the ComplianceRule model design where rich metadata is nested
    "metadata": {
        "name": cac_rule.get("title", rule_id),  # Rule name stored here
        ...
    }
}
```

---

## BUG #2: Hash Mismatch Due to Invalid Field

**File**: `backend/app/services/compliance_rules_deduplication_service.py` (line 55)

**Problem**:
- `EXCLUDED_FROM_HASH` set didn't include `'name'`
- Deduplication compared:
  - OLD (MongoDB): `name=None` (dropped by Pydantic)
  - NEW (bundle): `name="actual value"` (from converter)
- Result: False positive "2013 updated" instead of "2013 skipped"

**Fix Applied**:
```python
EXCLUDED_FROM_HASH = {
    # Metadata that changes on every import
    'imported_at', 'updated_at', 'source_file', 'source_hash',
    '_id', 'id', 'revision_id',
    # Immutable versioning fields
    'version', 'version_hash', 'is_latest', 'supersedes_version',
    'superseded_by', 'effective_from', 'effective_until',
    'source_bundle', 'source_bundle_hash', 'import_id',
    'change_summary', 'created_by',
    # Computed fields
    'derived_rules', 'parent_rule_id',
    # Invalid top-level fields (backward compatibility)
    'name',  # ← ADDED: Should only exist in metadata.name (not top-level)
}
```

---

## BUG #3: `_id` Persistence Through Versioning

**File**: `backend/app/services/compliance_rules_versioning_service.py` (line 268)

**Problem**:
- BSON parser normalized ObjectId `_id` to string
- Upload service removed `_id` at line 659-660
- But versioning service used `**rule_data` which reintroduced the `_id`
- MongoDB rejected duplicate `_id` when inserting new versions (each version needs unique `_id`)
- Result: "Failed to import rule: _id" errors for all 2013 rules

**Root Cause**:
```python
# BEFORE (BUG):
versioned_rule = {
    **rule_data,  # ← Spreads ALL fields including _id
    "version": new_version,
    ...
}
```

**Fix Applied**:
```python
# AFTER (FIXED):
# CRITICAL: Remove _id before spreading to prevent MongoDB duplicate key errors
# Each version must have a unique _id generated by MongoDB
clean_rule_data = {k: v for k, v in rule_data.items() if k != '_id'}

versioned_rule = {
    **clean_rule_data,  # ← Now spreads WITHOUT _id
    "version": new_version,
    ...
}
```

---

## Manual Testing Instructions

### Prerequisites
1. MongoDB is clean (all previous rules deleted)
2. Backend service is running with the fixes
3. v1.0.4 bundle is available at `/app/data/openwatch-rhel8-bundle_v1.0.4.tar.gz`

### Test 1: First Upload (Clean Import)

**Expected Result**: `2013 imported, 0 updated, 0 skipped, 0 failed`

**Steps**:
1. Log in to OpenWatch UI at http://localhost:3000
2. Navigate to **Content** → **Upload & Synchronize Rules** tab
3. Enable **Manual Upload**
4. Click **Choose File** and select `openwatch-rhel8-bundle_v1.0.4.tar.gz`
5. Click **Upload & Validate**
6. Click **Continue** in the confirmation dialog

**Verification**:
- Success message shows: "2013 imported"
- Backend logs show no "_id" errors
- Backend logs show no "HASH MISMATCH" errors for invalid 'name' field
- MongoDB now contains 2013 rules

**Backend Log Check**:
```bash
docker logs openwatch-backend --tail 100 | grep -E "imported|updated|skipped|Failed to import"
```

### Test 2: Re-Upload Same Bundle (Deduplication)

**Expected Result**: `0 imported, 0 updated, 2013 skipped, 0 failed`

**Steps**:
1. Immediately re-upload the **same** v1.0.4 bundle
2. Follow same steps as Test 1

**Verification**:
- Success message shows: "2013 skipped"
- Backend logs show: "CONTENT_MATCH - Skipping unchanged rule" for all 2013 rules
- No new rules inserted into MongoDB (still 2013 total)

**Backend Log Check**:
```bash
docker logs openwatch-backend --tail 50 | grep -E "CONTENT_MATCH|Skipping unchanged"
```

### Test 3: Verify MongoDB Data Structure

**Expected Result**: Rules have proper structure without top-level `name` field

**Steps**:
```bash
docker exec openwatch-backend python3 -c "
import asyncio
import sys
sys.path.insert(0, '/app')

async def check_rules():
    from backend.app.models.mongo_models import ComplianceRule
    from beanie import init_beanie
    from motor.motor_asyncio import AsyncIOMotorClient
    from backend.app.config import get_settings

    settings = get_settings()
    client = AsyncIOMotorClient(settings.mongodb_url)
    db = client.get_default_database()
    await init_beanie(database=db, document_models=[ComplianceRule])

    # Get one rule
    rule = await ComplianceRule.find_one()
    if rule:
        rule_dict = rule.dict()
        print(f'Rule ID: {rule_dict.get(\"rule_id\")}')
        print(f'Has top-level name? {\"name\" in rule_dict}')
        print(f'metadata.name: {rule_dict.get(\"metadata\", {}).get(\"name\", \"NOT FOUND\")}')
        print(f'Has _id? {\"_id\" in rule_dict or hasattr(rule, \"_id\")}')
    else:
        print('No rules found')

    client.close()

asyncio.run(check_rules())
"
```

**Expected Output**:
```
Rule ID: ow-<something>
Has top-level name? False
metadata.name: <actual rule name>
Has _id? True
```

---

## Rollback Instructions

If testing reveals issues, you can rollback by:

1. **Restore converter** (removes fix for BUG #1):
```bash
git checkout HEAD -- backend/app/cli/scap_json_to_openwatch_converter.py
```

2. **Restore deduplication service** (removes fix for BUG #2):
```bash
git checkout HEAD -- backend/app/services/compliance_rules_deduplication_service.py
```

3. **Restore versioning service** (removes fix for BUG #3):
```bash
git checkout HEAD -- backend/app/services/compliance_rules_versioning_service.py
```

4. **Restart backend**:
```bash
docker-compose restart backend
```

---

## Additional Files Created

- **docs/RSA_KEY_GENERATION_STRATEGY.md** - Comprehensive guide for RSA keypair management (881 lines)
- **scap_content/build/openwatch_bundles/rhel8/openwatch-rhel8-bundle_v1.0.4.tar.gz** - New bundle with all fixes

---

## Environment Configuration

The development environment is configured for permissive signature mode:

**File**: `docker-compose.yml` (line 98)
```yaml
REQUIRE_BUNDLE_SIGNATURE: "false"  # Set to "true" in production
```

**File**: `.env` (newly created)
```bash
REQUIRE_BUNDLE_SIGNATURE=false
```

---

## Commit Message Template

When ready to commit, use:

```bash
git add backend/app/cli/scap_json_to_openwatch_converter.py
git add backend/app/services/compliance_rules_deduplication_service.py
git add backend/app/services/compliance_rules_versioning_service.py
git add docs/RSA_KEY_GENERATION_STRATEGY.md
git add .env
git add docker-compose.yml

git commit -m "fix: Resolve three critical bugs in compliance bundle upload system

BUG #1: Remove invalid top-level 'name' field from converter
- Converter was creating top-level 'name' field not in ComplianceRule model
- Pydantic dropped field → MongoDB stored name=None
- Fix: Store name ONLY in metadata.name (matches model design)

BUG #2: Exclude 'name' from hash calculation for backward compatibility
- Deduplication compared OLD (name=None) vs NEW (name=value)
- Caused false positive '2013 updated' instead of '2013 skipped'
- Fix: Added 'name' to EXCLUDED_FROM_HASH set

BUG #3: Remove _id before spreading in versioning service
- Versioning service used **rule_data including _id
- MongoDB rejected duplicate _id when inserting new versions
- Fix: Explicit _id removal before spreading rule data

All fixes tested with clean MongoDB and v1.0.4 bundle.

Related: PR #143 (RSA signature verification)
"
```

---

## Status

✅ All three bugs are fixed in the code
✅ MongoDB has been cleared (2013 old rules deleted)
✅ v1.0.4 bundle has been created with the fixed converter
⏳ **Manual testing required** to verify fixes work end-to-end

**Next Steps**:
1. Perform Test 1 (first upload) via UI
2. Perform Test 2 (re-upload for deduplication) via UI
3. If both tests pass → commit all changes
4. Update PR #143 with these bug fixes
