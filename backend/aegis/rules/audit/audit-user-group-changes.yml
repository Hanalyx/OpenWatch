id: audit-user-group-changes
title: Audit user and group modifications
description: >
  Changes to user and group identity files must be audited. This includes
  modifications to /etc/passwd, /etc/shadow, /etc/group, and /etc/gshadow.
rationale: >
  Auditing changes to identity files allows detection of unauthorized account
  creation, privilege escalation, or account manipulation.
severity: medium
category: audit
tags: [audit, auditd, identity]

references:
  cis:
    rhel8_v4:  { section: "4.1.3.5", level: "L2", type: "Automated" }
    rhel9_v2:  { section: "4.1.3.5", level: "L2", type: "Automated" }
  stig:
    rhel9_v2r7:
      vuln_id: "V-257871"
      stig_id: "RHEL-09-654015"
      severity: "CAT II"
  nist_800_53: ["AU-2", "AU-12", "AC-2"]

platforms:
  - family: rhel
    min_version: 8

implementations:
  - default: true
    check:
      method: command
      # Check all identity files are audited (flexible key name matching)
      run: |
        auditctl -l 2>/dev/null | grep -q '^-w /etc/passwd.*-p wa' && \
        auditctl -l 2>/dev/null | grep -q '^-w /etc/shadow.*-p wa' && \
        auditctl -l 2>/dev/null | grep -q '^-w /etc/group.*-p wa' && \
        auditctl -l 2>/dev/null | grep -q '^-w /etc/gshadow.*-p wa'
      expected_exit: 0
    remediation:
      steps:
        - mechanism: audit_rule_set
          rule: "-w /etc/passwd -p wa -k identity"
          persist_file: "/etc/audit/rules.d/50-identity.rules"
        - mechanism: audit_rule_set
          rule: "-w /etc/shadow -p wa -k identity"
          persist_file: "/etc/audit/rules.d/50-identity.rules"
        - mechanism: audit_rule_set
          rule: "-w /etc/group -p wa -k identity"
          persist_file: "/etc/audit/rules.d/50-identity.rules"
        - mechanism: audit_rule_set
          rule: "-w /etc/gshadow -p wa -k identity"
          persist_file: "/etc/audit/rules.d/50-identity.rules"
