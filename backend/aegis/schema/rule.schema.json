{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://aegis.hanalyx.com/schema/rule/v0",
  "title": "Aegis Canonical Rule Schema",
  "description": "Schema for Aegis canonical compliance rules â€” version 0",
  "version": "0.1.0",
  "type": "object",
  "required": ["id", "title", "description", "rationale", "severity", "category", "platforms", "implementations"],
  "additionalProperties": false,
  "properties": {
    "id": {
      "type": "string",
      "pattern": "^[a-z][a-z0-9]*(-[a-z0-9]+)*$",
      "description": "Unique rule identifier in kebab-case"
    },
    "title": {
      "type": "string",
      "maxLength": 100,
      "description": "Human-readable title in imperative form"
    },
    "description": {
      "type": "string",
      "description": "What this rule enforces and its security context"
    },
    "rationale": {
      "type": "string",
      "description": "Security justification for this control"
    },
    "severity": {
      "type": "string",
      "enum": ["critical", "high", "medium", "low"],
      "description": "Aegis severity rating"
    },
    "category": {
      "type": "string",
      "enum": [
        "access-control",
        "audit",
        "filesystem",
        "kernel",
        "logging",
        "network",
        "services",
        "system"
      ],
      "description": "Top-level category matching the rules/ subdirectory"
    },
    "tags": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Free-form classification labels"
    },
    "references": { "$ref": "#/$defs/references" },
    "platforms": {
      "type": "array",
      "items": { "$ref": "#/$defs/platform" },
      "minItems": 1,
      "description": "OS families and versions this rule applies to"
    },
    "implementations": {
      "type": "array",
      "items": { "$ref": "#/$defs/implementation" },
      "minItems": 1,
      "description": "Capability-gated check+remediation variants"
    },
    "depends_on": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Rule IDs that must pass before this rule remediates"
    },
    "conflicts_with": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Rule IDs that are mutually exclusive"
    },
    "supersedes": {
      "type": "array",
      "items": { "type": "string" },
      "description": "Rule IDs this rule replaces"
    }
  },

  "$defs": {

    "references": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "cis": {
          "type": "object",
          "description": "CIS Benchmark references keyed by os_version",
          "patternProperties": {
            "^[a-z]+[0-9]+_v[0-9]+$": { "$ref": "#/$defs/cis_reference" }
          },
          "additionalProperties": false
        },
        "stig": {
          "type": "object",
          "description": "DISA STIG references keyed by os_version",
          "patternProperties": {
            "^[a-z]+[0-9]+_v[0-9]+r[0-9]+$": { "$ref": "#/$defs/stig_reference" }
          },
          "additionalProperties": false
        },
        "nist_800_53": {
          "type": "array",
          "items": { "type": "string" },
          "description": "NIST 800-53 Rev 5 control identifiers"
        },
        "pci_dss_4": {
          "type": "array",
          "items": { "type": "string" },
          "description": "PCI DSS v4.0 requirement identifiers"
        },
        "iso27001_2022": {
          "type": "array",
          "items": { "type": "string" },
          "description": "ISO 27001:2022 control identifiers"
        },
        "cmmc_l2": {
          "type": "array",
          "items": { "type": "string" },
          "description": "CMMC Level 2 practice identifiers"
        },
        "hipaa": {
          "type": "array",
          "items": { "type": "string" },
          "description": "HIPAA Security Rule section identifiers"
        },
        "srg": {
          "type": "array",
          "items": { "type": "string" },
          "description": "DISA SRG identifiers"
        },
        "cci": {
          "type": "array",
          "items": { "type": "string" },
          "description": "CCI identifiers (when shared across STIG versions)"
        }
      }
    },

    "cis_reference": {
      "type": "object",
      "required": ["section"],
      "additionalProperties": false,
      "properties": {
        "section": {
          "type": "string",
          "description": "CIS section number (e.g., '5.2.10')"
        },
        "level": {
          "type": "string",
          "enum": ["L1", "L2"],
          "description": "CIS profile level"
        },
        "type": {
          "type": "string",
          "enum": ["Automated", "Manual"],
          "description": "Assessment type"
        },
        "profile": {
          "type": "string",
          "description": "Primary applicable profile"
        }
      }
    },

    "stig_reference": {
      "type": "object",
      "required": ["vuln_id"],
      "additionalProperties": false,
      "properties": {
        "vuln_id": {
          "type": "string",
          "pattern": "^V-[0-9]+$",
          "description": "Vulnerability ID (e.g., 'V-230296')"
        },
        "rule_id": {
          "type": "string",
          "description": "Rule ID with revision (e.g., 'SV-230296r1017040_rule')"
        },
        "stig_id": {
          "type": "string",
          "description": "STIG rule version ID (e.g., 'RHEL-08-010550')"
        },
        "severity": {
          "type": "string",
          "enum": ["CAT I", "CAT II", "CAT III"],
          "description": "DISA severity category"
        },
        "cci": {
          "type": "array",
          "items": { "type": "string" },
          "description": "CCI identifiers for this STIG version"
        }
      }
    },

    "platform": {
      "type": "object",
      "required": ["family", "min_version"],
      "additionalProperties": false,
      "properties": {
        "family": {
          "type": "string",
          "enum": ["rhel", "debian", "suse"],
          "description": "OS family"
        },
        "min_version": {
          "type": "integer",
          "minimum": 1,
          "description": "Minimum major version (inclusive)"
        },
        "max_version": {
          "type": "integer",
          "minimum": 1,
          "description": "Maximum major version (inclusive). Omit for open-ended."
        },
        "derivatives": {
          "type": "boolean",
          "default": true,
          "description": "Include binary-compatible derivatives"
        }
      }
    },

    "implementation": {
      "type": "object",
      "required": ["check", "remediation"],
      "additionalProperties": false,
      "properties": {
        "when": { "$ref": "#/$defs/capability_gate" },
        "default": {
          "type": "boolean",
          "description": "True if this is the default (fallback) implementation"
        },
        "check": { "$ref": "#/$defs/check" },
        "remediation": { "$ref": "#/$defs/remediation" }
      }
    },

    "capability_gate": {
      "description": "Capability condition for implementation selection",
      "oneOf": [
        {
          "type": "string",
          "description": "Single capability name"
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "all": {
              "type": "array",
              "items": { "type": "string" },
              "minItems": 2,
              "description": "All capabilities must be true"
            }
          },
          "required": ["all"]
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "any": {
              "type": "array",
              "items": { "type": "string" },
              "minItems": 2,
              "description": "At least one capability must be true"
            }
          },
          "required": ["any"]
        },
        {
          "type": "object",
          "additionalProperties": false,
          "properties": {
            "not": {
              "type": "string",
              "description": "Capability must be false"
            }
          },
          "required": ["not"]
        }
      ]
    },

    "check": {
      "description": "Verification of desired state",
      "oneOf": [
        {
          "type": "object",
          "required": ["method"],
          "properties": {
            "method": { "$ref": "#/$defs/check_method" },
            "path": { "type": "string" },
            "key": { "type": "string" },
            "expected": { "type": "string" },
            "comparator": {
              "type": "string",
              "enum": [">=", "<=", ">", "<", "=="],
              "description": "Comparison operator for expected value (default: ==)"
            },
            "not_expected": { "type": "string" },
            "scan_pattern": { "type": "string" },
            "name": { "type": "string" },
            "state": { "type": "string" },
            "enabled": { "type": "boolean" },
            "active": { "type": "boolean" },
            "owner": { "type": "string" },
            "group": { "type": "string" },
            "mode": { "type": "string" },
            "mount_point": { "type": "string" },
            "options": { "type": "array", "items": { "type": "string" } },
            "pattern": { "type": "string" },
            "rule": { "type": "string" },
            "run": { "type": "string" },
            "expected_exit": { "type": "integer" },
            "expected_stdout": { "type": "string" },
            "service": { "type": "string" },
            "type": { "type": "string" },
            "module": { "type": "string" },
            "args": { "type": "string" },
            "value": { "type": "string" }
          }
        },
        {
          "type": "object",
          "required": ["checks"],
          "additionalProperties": false,
          "properties": {
            "checks": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["method"],
                "properties": {
                  "method": { "$ref": "#/$defs/check_method" },
                  "path": { "type": "string" },
                  "key": { "type": "string" },
                  "expected": { "type": "string" },
                  "comparator": {
                    "type": "string",
                    "enum": [">=", "<=", ">", "<", "=="],
                    "description": "Comparison operator for expected value (default: ==)"
                  },
                  "not_expected": { "type": "string" },
                  "scan_pattern": { "type": "string" },
                  "name": { "type": "string" },
                  "state": { "type": "string" },
                  "enabled": { "type": "boolean" },
                  "active": { "type": "boolean" },
                  "owner": { "type": "string" },
                  "group": { "type": "string" },
                  "mode": { "type": "string" },
                  "mount_point": { "type": "string" },
                  "options": { "type": "array", "items": { "type": "string" } },
                  "pattern": { "type": "string" },
                  "rule": { "type": "string" },
                  "run": { "type": "string" },
                  "expected_exit": { "type": "integer" },
                  "expected_stdout": { "type": "string" },
                  "service": { "type": "string" },
                  "type": { "type": "string" },
                  "module": { "type": "string" },
                  "args": { "type": "string" },
                  "value": { "type": "string" }
                }
              },
              "minItems": 2
            }
          }
        }
      ]
    },

    "check_method": {
      "type": "string",
      "enum": [
        "config_value",
        "config_absent",
        "file_permission",
        "file_exists",
        "file_not_exists",
        "file_content_match",
        "file_content_no_match",
        "service_state",
        "systemd_target",
        "package_state",
        "sysctl_value",
        "kernel_module_state",
        "mount_option",
        "audit_rule_exists",
        "grub_parameter",
        "selinux_boolean",
        "selinux_state",
        "pam_module",
        "command"
      ]
    },

    "remediation": {
      "description": "Enforcement of desired state",
      "oneOf": [
        {
          "type": "object",
          "required": ["mechanism"],
          "properties": {
            "mechanism": { "$ref": "#/$defs/remediation_mechanism" },
            "path": { "type": "string" },
            "key": { "type": "string" },
            "value": { "type": "string" },
            "separator": { "type": "string" },
            "create": { "type": "boolean" },
            "dir": { "type": "string" },
            "file": { "type": "string" },
            "block": { "type": "string" },
            "marker": { "type": "string" },
            "content": { "type": "string" },
            "owner": { "type": "string" },
            "group": { "type": "string" },
            "mode": { "type": "string" },
            "name": { "type": "string" },
            "persist_file": { "type": "string" },
            "rule": { "type": "string" },
            "mount_point": { "type": "string" },
            "options": { "type": "array", "items": { "type": "string" } },
            "module": { "type": "string" },
            "type": { "type": "string" },
            "control": { "type": "string" },
            "args": { "type": "string" },
            "schedule": { "type": "string" },
            "command": { "type": "string" },
            "user": { "type": "string" },
            "persistent": { "type": "boolean" },
            "start": { "type": "boolean", "description": "Start service after enabling" },
            "stop": { "type": "boolean", "description": "Stop service before disabling/masking" },
            "run": { "type": "string" },
            "unless": { "type": "string" },
            "onlyif": { "type": "string" },
            "reload": { "type": "string" },
            "restart": { "type": "string" },
            "notify": { "type": "string" },
            "note": { "type": "string", "description": "Guidance for manual remediation" }
          }
        },
        {
          "type": "object",
          "required": ["steps"],
          "additionalProperties": false,
          "properties": {
            "steps": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["mechanism"],
                "properties": {
                  "mechanism": { "$ref": "#/$defs/remediation_mechanism" },
                  "path": { "type": "string" },
                  "key": { "type": "string" },
                  "value": { "type": "string" },
                  "separator": { "type": "string" },
                  "create": { "type": "boolean" },
                  "dir": { "type": "string" },
                  "file": { "type": "string" },
                  "block": { "type": "string" },
                  "marker": { "type": "string" },
                  "content": { "type": "string" },
                  "owner": { "type": "string" },
                  "group": { "type": "string" },
                  "mode": { "type": "string" },
                  "name": { "type": "string" },
                  "persist_file": { "type": "string" },
                  "rule": { "type": "string" },
                  "mount_point": { "type": "string" },
                  "options": { "type": "array", "items": { "type": "string" } },
                  "module": { "type": "string" },
                  "type": { "type": "string" },
                  "control": { "type": "string" },
                  "args": { "type": "string" },
                  "schedule": { "type": "string" },
                  "command": { "type": "string" },
                  "user": { "type": "string" },
                  "persistent": { "type": "boolean" },
                  "start": { "type": "boolean", "description": "Start service after enabling" },
                  "stop": { "type": "boolean", "description": "Stop service before disabling/masking" },
                  "run": { "type": "string" },
                  "unless": { "type": "string" },
                  "onlyif": { "type": "string" },
                  "reload": { "type": "string" },
                  "restart": { "type": "string" },
                  "notify": { "type": "string" }
                }
              },
              "minItems": 2
            }
          }
        }
      ]
    },

    "remediation_mechanism": {
      "type": "string",
      "enum": [
        "config_set",
        "config_set_dropin",
        "config_remove",
        "config_block",
        "file_permissions",
        "file_absent",
        "file_content",
        "service_enabled",
        "service_disabled",
        "service_masked",
        "package_present",
        "package_absent",
        "sysctl_set",
        "kernel_module_disable",
        "grub_parameter_set",
        "grub_parameter_remove",
        "mount_option_set",
        "pam_module_configure",
        "audit_rule_set",
        "selinux_boolean_set",
        "cron_job",
        "command_exec",
        "manual"
      ]
    }
  }
}
