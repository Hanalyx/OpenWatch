"""Add XCCDF native score fields to scan_results

Revision ID: 010
Revises: 009
Create Date: 2025-11-07 14:00:00.000000

This migration adds XCCDF native score fields to support proper
XCCDF standard compliance scoring per the XCCDF specification.

Fields added:
- xccdf_score: Native XCCDF score from TestResult element (0.0-100.0 typically)
- xccdf_score_system: Scoring system URN (e.g., urn:xccdf:scoring:default)
- xccdf_score_max: Maximum possible score (usually 100.0)

These scores are extracted from the XCCDF <TestResult><score> elements
generated by OpenSCAP. They may be 0.0 if SCAP content doesn't define
rule weights (expected for ComplianceAsCode/SSG content).

Reference: XCCDF_SCORING_IMPLEMENTATION_PLAN_REVISED.md Phase 1.1
"""

import sqlalchemy as sa

from alembic import op

# revision identifiers, used by Alembic.
revision = "20251107_add_xccdf_scores"
down_revision = "20250106_scap_cleanup"
branch_labels = None
depends_on = None


def upgrade():
    """Add XCCDF native score columns to scan_results table"""

    # Add xccdf_score column
    op.add_column(
        "scan_results",
        sa.Column(
            "xccdf_score",
            sa.Float,
            nullable=True,
            comment="Native XCCDF score from TestResult element (0.0-100.0 typically)",
        ),
    )

    # Add xccdf_score_system column
    op.add_column(
        "scan_results",
        sa.Column(
            "xccdf_score_system",
            sa.String(255),
            nullable=True,
            comment="XCCDF scoring system URN (e.g., urn:xccdf:scoring:default)",
        ),
    )

    # Add xccdf_score_max column
    op.add_column(
        "scan_results",
        sa.Column("xccdf_score_max", sa.Float, nullable=True, comment="Maximum possible XCCDF score (usually 100.0)"),
    )

    print("Added XCCDF native score columns to scan_results table")


def downgrade():
    """Remove XCCDF native score columns from scan_results table"""

    op.drop_column("scan_results", "xccdf_score_max")
    op.drop_column("scan_results", "xccdf_score_system")
    op.drop_column("scan_results", "xccdf_score")

    print("Removed XCCDF native score columns from scan_results table")
