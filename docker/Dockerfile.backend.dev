# OpenWatch Backend - Development Container
#
# Updated to Python 3.12 to match production environment
# Python 3.9 reached END OF LIFE on 2025-10-31
#
# Base Image: Official Python 3.12 slim (Debian-based)
# - Lighter weight than UBI9 for faster dev iteration
# - Same Python version as production for compatibility

FROM python:3.12-slim

LABEL maintainer="OpenWatch Security Team" \
      org.opencontainers.image.title="OpenWatch Backend (Dev)" \
      org.opencontainers.image.description="Development container - Python 3.12" \
      python.version="3.12" \
      environment="development"

# Install system dependencies including OpenSCAP and networking tools
# Note: python3-openscap removed as it binds to system Python, not container Python
RUN apt-get update && \
    apt-get install -y \
        gcc \
        libpq-dev \
        openssh-client \
        curl \
        unzip \
        openscap-scanner \
        libopenscap25 \
        openscap-common \
        xmlstarlet \
        git \
        iputils-ping \
        netcat-openbsd \
        telnet \
        nmap && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/*

# Install additional SCAP content
RUN mkdir -p /usr/share/xml/scap/ssg/content && \
    curl -L https://github.com/ComplianceAsCode/content/releases/download/v0.1.68/scap-security-guide-0.1.68.zip -o /tmp/ssg.zip && \
    cd /tmp && unzip -q ssg.zip && \
    cp -r scap-security-guide-*/ssg-* /usr/share/xml/scap/ssg/content/ 2>/dev/null || true && \
    rm -rf /tmp/ssg.zip /tmp/scap-security-guide-* || true

# Create application user with high UID/GID to avoid collisions
RUN useradd -m -u 10001 openwatch && \
    mkdir -p /openwatch /openwatch/data /openwatch/logs && \
    chown -R openwatch:openwatch /openwatch

# Set working directory to mirror dev environment root
WORKDIR /openwatch

# Copy requirements and install Python dependencies
COPY backend/requirements.txt .
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY backend/ ./backend/

# Set proper permissions
RUN chown -R openwatch:openwatch /openwatch && \
    chmod -R 755 /openwatch

# Create directories for runtime data
RUN mkdir -p /openwatch/data/{scap,results,uploads} /openwatch/logs && \
    chown -R openwatch:openwatch /openwatch/data /openwatch/logs && \
    chmod -R 755 /openwatch/logs

# Copy entrypoint script and set permissions before switching user
COPY docker/entrypoint-backend.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Switch to non-root user
USER openwatch

# Expose port
EXPOSE 8000

# Environment variables
# PYTHONPATH points to backend/ so 'from app.X' resolves to backend/app/X
ENV PYTHONPATH=/openwatch/backend \
    OPENWATCH_LOG_LEVEL=DEBUG

# Set entrypoint
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]

# Start command
CMD ["python", "-m", "uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
