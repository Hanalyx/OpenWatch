# OpenWatch File Access Policy Rules Template
# Generated by OpenWatch RPM package installer
# 
# These rules allow OpenWatch SCAP compliance platform to operate
# with fapolicyd application whitelisting enabled on RHEL/Oracle Linux
#
# This template is used by the configure-fapolicyd.sh script to generate
# the actual rules file at /etc/fapolicyd/rules.d/90-openwatch.rules

# =============================================================================
# Core OpenWatch Components
# =============================================================================

# OpenWatch admin CLI tool
allow perm=any all : path=/usr/bin/owadm type=application/x-executable

# OpenWatch systemd integration
allow perm=execute all : path=/usr/bin/systemctl type=application/x-executable

# =============================================================================
# Container Runtime Support - Podman (RHEL/Oracle Linux default)
# =============================================================================

# Podman core components
allow perm=execute all : path=/usr/bin/podman type=application/x-executable
allow perm=execute all : path=/usr/bin/podman-compose type=application/x-executable
allow perm=execute all : path=/usr/bin/conmon type=application/x-executable

# Container runtime engines
allow perm=execute all : path=/usr/bin/crun type=application/x-executable
allow perm=execute all : path=/usr/bin/runc type=application/x-executable

# Podman rootless networking
allow perm=execute uid=openwatch : path=/usr/bin/slirp4netns type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/pasta type=application/x-executable

# Podman storage drivers
allow perm=execute uid=openwatch : path=/usr/bin/fuse-overlayfs type=application/x-executable

# Container image management
allow perm=execute all : path=/usr/bin/buildah type=application/x-executable
allow perm=execute all : path=/usr/bin/skopeo type=application/x-executable

# =============================================================================
# Container Runtime Support - Docker (Alternative)
# =============================================================================

# Docker core components
allow perm=execute all : path=/usr/bin/docker type=application/x-executable
allow perm=execute all : path=/usr/bin/docker-compose type=application/x-executable
allow perm=execute all : path=/usr/bin/dockerd type=application/x-executable

# Docker container runtime
allow perm=execute all : path=/usr/bin/containerd type=application/x-executable
allow perm=execute all : path=/usr/bin/containerd-shim type=application/x-executable
allow perm=execute all : path=/usr/bin/containerd-shim-runc-v1 type=application/x-executable
allow perm=execute all : path=/usr/bin/containerd-shim-runc-v2 type=application/x-executable

# Docker networking and init
allow perm=execute all : path=/usr/bin/docker-proxy type=application/x-executable
allow perm=execute all : path=/usr/bin/docker-init type=application/x-executable
allow perm=execute all : path=/usr/bin/tini type=application/x-executable

# =============================================================================
# SCAP Scanning Tools
# =============================================================================

# OpenSCAP scanner components
allow perm=execute all : path=/usr/bin/oscap type=application/x-executable
allow perm=execute all : path=/usr/bin/oscap-ssh type=application/x-executable

# OpenSCAP library executables
allow perm=execute uid=openwatch : dir=/usr/libexec/openscap type=application/x-executable

# SCAP content validation tools
allow perm=execute uid=openwatch : path=/usr/bin/xmllint type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/xmlstarlet type=application/x-executable

# =============================================================================
# Python Runtime and Dependencies
# =============================================================================

# Python interpreter versions (for backend services)
allow perm=execute uid=openwatch : path=/usr/bin/python3 type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/python3.8 type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/python3.9 type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/python3.10 type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/python3.11 type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/python3.12 type=application/x-executable

# Python package management
allow perm=execute uid=openwatch : path=/usr/bin/pip3 type=application/x-executable

# =============================================================================
# System Utilities Required by OpenWatch
# =============================================================================

# Shell interpreters
allow perm=execute uid=openwatch : path=/bin/bash type=application/x-executable
allow perm=execute uid=openwatch : path=/bin/sh type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/bash type=application/x-executable

# SSH client suite for remote scanning
allow perm=execute uid=openwatch : path=/usr/bin/ssh type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/scp type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/ssh-keygen type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/ssh-copy-id type=application/x-executable

# System information gathering
allow perm=execute uid=openwatch : path=/usr/bin/uname type=application/x-executable
allow perm=execute uid=openwatch : path=/bin/ps type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/ps type=application/x-executable

# Text processing utilities
allow perm=execute uid=openwatch : path=/bin/grep type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/grep type=application/x-executable
allow perm=execute uid=openwatch : path=/bin/sed type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/sed type=application/x-executable
allow perm=execute uid=openwatch : path=/bin/awk type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/awk type=application/x-executable

# File operations
allow perm=execute uid=openwatch : path=/bin/cat type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/cat type=application/x-executable
allow perm=execute uid=openwatch : path=/bin/cp type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/cp type=application/x-executable
allow perm=execute uid=openwatch : path=/bin/mv type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/mv type=application/x-executable
allow perm=execute uid=openwatch : path=/bin/rm type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/rm type=application/x-executable
allow perm=execute uid=openwatch : path=/bin/mkdir type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/mkdir type=application/x-executable

# Advanced text processing
allow perm=execute uid=openwatch : path=/usr/bin/sort type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/uniq type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/head type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/tail type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/cut type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/tr type=application/x-executable

# Compression and archival
allow perm=execute uid=openwatch : path=/usr/bin/gzip type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/gunzip type=application/x-executable
allow perm=execute uid=openwatch : path=/usr/bin/tar type=application/x-executable
allow perm=execute uid=openwatch : path=/bin/tar type=application/x-executable

# =============================================================================
# Directory Permissions
# =============================================================================

# OpenWatch configuration and data directories
allow perm=any uid=openwatch : dir=/etc/openwatch
allow perm=any uid=openwatch : dir=/var/lib/openwatch
allow perm=any uid=openwatch : dir=/var/log/openwatch
allow perm=any uid=openwatch : dir=/var/cache/openwatch

# Container storage directories (Podman rootless)
allow perm=any uid=openwatch : dir=/home/openwatch/.local/share/containers
allow perm=any uid=openwatch : dir=/home/openwatch/.config/containers
allow perm=any uid=openwatch : dir=/home/openwatch/.cache/containers

# Container storage directories (system-wide)
allow perm=any uid=openwatch : dir=/var/lib/containers
allow perm=any uid=openwatch : dir=/var/lib/docker

# Temporary directories for scanning operations
allow perm=any uid=openwatch : dir=/tmp
allow perm=any uid=openwatch : dir=/var/tmp

# =============================================================================
# Shared Libraries and Dynamic Loading
# =============================================================================

# Standard library directories
allow perm=execute uid=openwatch : dir=/usr/lib64
allow perm=execute uid=openwatch : dir=/usr/lib
allow perm=execute uid=openwatch : dir=/lib64
allow perm=execute uid=openwatch : dir=/lib

# Python modules and packages
allow perm=execute uid=openwatch : dir=/usr/lib/python3*
allow perm=execute uid=openwatch : dir=/usr/lib64/python3*

# =============================================================================
# Additional Security Considerations
# =============================================================================

# Note: These rules are designed to be minimal and specific to OpenWatch
# They follow the principle of least privilege while enabling full functionality
# 
# For production environments, consider:
# 1. Regular review of these rules
# 2. Monitoring fapolicyd logs for denied operations
# 3. Testing rule changes in non-production environments first
# 4. Using more restrictive rules if your environment doesn't require all features
#
# To customize rules for your environment:
# 1. Copy this file to /etc/fapolicyd/rules.d/90-openwatch.rules
# 2. Modify as needed for your specific requirements
# 3. Reload fapolicyd: systemctl reload fapolicyd
# 4. Test OpenWatch functionality thoroughly